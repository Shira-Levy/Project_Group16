<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>My Bookings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
  <div class="container wide">

    <!-- USER HEADER -->
    <div class="user-bar">
      <div class="user-left">
        <img src="{{ url_for('static', filename='flytau_logo.png') }}" class="small-logo" alt="FLYTAU Logo"
          style="margin-right: 15px;">
        <div class="user-avatar">
          {{ session.get("first_name")[0] }}
        </div>

        <div class="user-text">
          <div class="user-title" title="{{ session.get('first_name') }}">
            {{ session.get("first_name") }}
          </div>
          <div class="user-subtitle">
            Logged in as
            <span class="role-badge role-{{ session.get('role') }}">
              {{ session.get("role") }}
            </span>
          </div>
        </div>
      </div>

      <a href="{{ url_for('logout') }}" class="btn btn-logout">Logout</a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="error-box"
      style="margin-bottom: 20px; text-align: center; color: #b00020; border: 1px solid #b00020; background-color: #ffe6e6; padding: 10px; border-radius: 8px;">
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div class="action-box" style="margin-bottom: 20px;">
      <a href="{{ url_for('home_page') }}" class="btn secondary-btn">Home</a>
      <a href="{{ url_for('search') }}" class="btn main-btn">Search Flights</a>
    </div>

    <h2 class="form-subtitle">My Bookings</h2>

    <!-- STATUS FILTER -->
    <!-- STATUS FILTER -->
    {% if available_statuses %}
    <div
      style="background: white; padding: 16px 20px; border-radius: 14px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); margin-bottom: 25px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 15px;">

      <form method="GET" action="{{ url_for('my_bookings') }}"
        style="display: flex; align-items: center; gap: 12px; flex-grow: 1;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#0b3558" stroke-width="2"
            stroke-linecap="round" stroke-linejoin="round">
            <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
          </svg>
          <span style="font-weight: 700; color: #0b3558; font-size: 15px;">Filter Bookings:</span>
        </div>

        <select name="status" onchange="this.form.submit()"
          style="padding: 8px 14px; border-radius: 10px; border: 1px solid #cce0ff; background-color: #f8fbff; color: #0b3558; font-weight: 600; font-size: 14px; cursor: pointer; outline: none; transition: border 0.2s;">
          <option value="">Show All</option>
          {% for s in available_statuses %}
          <option value="{{ s }}" {% if current_status==s %}selected{% endif %}>{{ s }}</option>
          {% endfor %}
        </select>
      </form>

      {% if current_status %}
      <a href="{{ url_for('my_bookings') }}"
        style="font-size: 14px; color: #b00020; font-weight: 600; text-decoration: none; padding: 6px 14px; background: rgba(176, 0, 32, 0.08); border-radius: 8px; transition: 0.2s;"
        onmouseover="this.style.background='rgba(176, 0, 32, 0.15)'"
        onmouseout="this.style.background='rgba(176, 0, 32, 0.08)'">
        âœ• Clear Filter
      </a>
      {% endif %}
    </div>
    {% endif %}

    <!-- ===== UPCOMING BOOKINGS ===== -->
    <h2 class="form-subtitle" style="margin-top: 22px;">Upcoming Bookings</h2>

    {% if not upcoming %}
    <div style="
        margin-top: 10px;
        padding: 14px;
        border-radius: 12px;
        background: rgba(46, 204, 113, 0.12);
        border: 1px solid rgba(46, 204, 113, 0.28);
        color: #0f5c33;
        font-weight: 600;
        text-align: center;">
      No upcoming bookings.
    </div>
    {% else %}
    <div class="results-wrapper">
      <table class="results-table">
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Status</th>
            <th>Booked At</th>
            <th>Flight ID</th>
            <th>Flight Date</th>
            <th>Flight Time</th>
            <th>Tickets</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for b in upcoming %}
          <tr>
            <td class="mono">{{ b.B_ID }}</td>

            <!-- STATUS COLOR MAPPING -->
            <td>
              {% set s = (b.Status or 'Unknown')|lower %}
              {% if s == 'confirmed' %}
              <span class="pill pill-active">{{ b.Status }}</span>
              {% elif 'cancel' in s %}
              <span class="pill pill-cancelled">{{ b.Status }}</span>
              {% elif s == 'scheduled' %}
              <span class="pill pill-scheduled">{{ b.Status }}</span>
              {% else %}
              <span class="pill pill-scheduled">{{ b.Status or 'Unknown' }}</span>
              {% endif %}
            </td>

            <td class="mono">{{ b.booking_date }} {{ b.booking_time }}</td>
            <td class="mono">{{ b.F_ID }}</td>
            <td class="mono">{{ b.Date_of_flight }}</td>
            <td class="mono">{{ b.Time_of_flight }}</td>
            <td class="mono">{{ b.tickets_count }}</td>

            <td class="actions-col">
              {% if b.can_cancel %}
              <form method="POST" action="{{ url_for('cancel_booking', booking_id=b.B_ID) }}"
                onsubmit="return confirm('Note: Cancelling a booking involves a fee of 5% of the transaction amount.\nAre you sure you want to proceed?');">
                <button type="submit" class="btn btn-small secondary-btn">Cancel</button>
              </form>
              {% else %}
              <span style="color: #b00020; font-weight: bold; font-size: 0.85rem;">
                Cannot cancel within 36 hours of flight
              </span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <!-- ===== PAST BOOKINGS ===== -->
    <h2 class="form-subtitle" style="margin-top: 26px;">Past Bookings</h2>

    {% if not past %}
    <div style="
        margin-top: 10px;
        padding: 14px;
        border-radius: 12px;
        background: rgba(255, 224, 138, 0.28);
        border: 1px solid rgba(255, 211, 106, 0.55);
        color: #7a4c00;
        font-weight: 600;
        text-align: center;">
      No past bookings.
    </div>
    {% else %}
    <div class="results-wrapper">
      <table class="results-table">
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Status</th>
            <th>Booked At</th>
            <th>Flight ID</th>
            <th>Flight Date</th>
            <th>Flight Time</th>
            <th>Tickets</th>
          </tr>
        </thead>

        <tbody>
          {% for b in past %}
          <tr>
            <td class="mono">{{ b.B_ID }}</td>

            <!-- Past flights: show Completed + original status -->
            <!-- Past flights: show Cancelled in red, or Completed in green -->
            <td>
              {% set s = (b.Status or 'Unknown')|lower %}
              {% if 'cancel' in s %}
              <span class="pill pill-cancelled">{{ b.Status }}</span>
              {% else %}
              <span class="pill pill-active">Completed</span>
              {% endif %}
            </td>

            <td class="mono">{{ b.booking_date }} {{ b.booking_time }}</td>
            <td class="mono">{{ b.F_ID }}</td>
            <td class="mono">{{ b.Date_of_flight }}</td>
            <td class="mono">{{ b.Time_of_flight }}</td>
            <td class="mono">{{ b.tickets_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

  </div>
</body>

</html>