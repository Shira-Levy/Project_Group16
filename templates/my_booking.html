<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <title>My Bookings</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
  <div class="container wide">

    <!-- USER HEADER -->
    <div class="user-bar">
      <div class="user-left">
        <img src="{{ url_for('static', filename='flytau_logo.png') }}" alt="FLYTAU"
          style="height: 40px; width: auto; margin-right: 10px;">
        <div class="user-avatar">
          {{ session.get("first_name")[0] }}
        </div>

        <div class="user-text">
          <div class="user-title" title="{{ session.get('first_name') }}">
            {{ session.get("first_name") }}
          </div>
          <div class="user-subtitle">
            Logged in as
            <span class="role-badge role-{{ session.get('role') }}">
              {{ session.get("role") }}
            </span>
          </div>
        </div>
      </div>

      <a href="{{ url_for('logout') }}" class="btn btn-logout">Logout</a>
    </div>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="error-box"
      style="margin-bottom: 20px; text-align: center; color: #b00020; border: 1px solid #b00020; background-color: #ffe6e6; padding: 10px; border-radius: 8px;">
      {{ message }}
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <h2 class="form-subtitle">My Bookings</h2>

    <div class="action-box">
      <a href="{{ url_for('home_page') }}" class="btn secondary-btn">Home</a>
      <a href="{{ url_for('search') }}" class="btn main-btn">Search Flights</a>
    </div>

    <!-- ===== UPCOMING BOOKINGS ===== -->
    <h2 class="form-subtitle" style="margin-top: 22px;">Upcoming Bookings</h2>

    {% if not upcoming %}
    <div style="
        margin-top: 10px;
        padding: 14px;
        border-radius: 12px;
        background: rgba(46, 204, 113, 0.12);
        border: 1px solid rgba(46, 204, 113, 0.28);
        color: #0f5c33;
        font-weight: 600;
        text-align: center;">
      No upcoming bookings.
    </div>
    {% else %}
    <div class="results-wrapper">
      <table class="results-table">
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Status</th>
            <th>Booked At</th>
            <th>Flight ID</th>
            <th>Flight Date</th>
            <th>Flight Time</th>
            <th>Tickets</th>
            <th class="actions-col">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for b in upcoming %}
          <tr>
            <td class="mono">{{ b.B_ID }}</td>

            <!-- STATUS COLOR MAPPING -->
            <td>
              {% set s = (b.Status or 'Unknown')|lower %}
              {% if s == 'confirmed' %}
              <span class="pill pill-active">{{ b.Status }}</span>
              {% elif s == 'cancelled' %}
              <span class="pill pill-cancelled">{{ b.Status }}</span>
              {% elif s == 'scheduled' %}
              <span class="pill pill-scheduled">{{ b.Status }}</span>
              {% else %}
              <span class="pill pill-scheduled">{{ b.Status or 'Unknown' }}</span>
              {% endif %}
            </td>

            <td class="mono">{{ b.booking_date }} {{ b.booking_time }}</td>
            <td class="mono">{{ b.F_ID }}</td>
            <td class="mono">{{ b.Date_of_flight }}</td>
            <td class="mono">{{ b.Time_of_flight }}</td>
            <td class="mono">{{ b.tickets_count }}</td>

            <td class="actions-col">
              <form method="POST" action="{{ url_for('cancel_booking', booking_id=b.B_ID) }}"
                onsubmit="return confirm('Are you sure you want to cancel this booking? This will release the seats.');">
                <button type="submit" class="btn btn-small secondary-btn">Cancel</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

    <!-- ===== PAST BOOKINGS ===== -->
    <h2 class="form-subtitle" style="margin-top: 26px;">Past Bookings</h2>

    {% if not past %}
    <div style="
        margin-top: 10px;
        padding: 14px;
        border-radius: 12px;
        background: rgba(255, 224, 138, 0.28);
        border: 1px solid rgba(255, 211, 106, 0.55);
        color: #7a4c00;
        font-weight: 600;
        text-align: center;">
      No past bookings.
    </div>
    {% else %}
    <div class="results-wrapper">
      <table class="results-table">
        <thead>
          <tr>
            <th>Booking ID</th>
            <th>Status</th>
            <th>Booked At</th>
            <th>Flight ID</th>
            <th>Flight Date</th>
            <th>Flight Time</th>
            <th>Tickets</th>
          </tr>
        </thead>

        <tbody>
          {% for b in past %}
          <tr>
            <td class="mono">{{ b.B_ID }}</td>

            <!-- Past flights: show Completed + original status -->
            <td>
              <span class="pill pill-active">Completed</span>
              <div class="muted">was: {{ b.Status or 'Unknown' }}</div>
            </td>

            <td class="mono">{{ b.booking_date }} {{ b.booking_time }}</td>
            <td class="mono">{{ b.F_ID }}</td>
            <td class="mono">{{ b.Date_of_flight }}</td>
            <td class="mono">{{ b.Time_of_flight }}</td>
            <td class="mono">{{ b.tickets_count }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% endif %}

  </div>
</body>

</html>